<!DOCTYPE html>
<html lang="en">

<head>
	<title>DataBC Location Services in Action</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.locatecontrol/0.60.0/L.Control.Locate.min.css" />
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.css" />
	<link href="https://aehlke.github.io/tag-it/css/jquery.tagit.css" rel="stylesheet" type="text/css">
	<style>
		/* make the map fullscreen */
		html, body {
            height: 100%;
            width: 100%;
        }
		body {
            padding: 0;
            margin: 0;
		}
		#container {
			height: 100%;
            width: 100%;
			overflow: hidden;
		}
		#map {
			height: 100%;
            width: 100%;
        }
		/* Slideable Sidebar */
		#tabWrapper {
			position: absolute;
			top: 0;
			left: 0;
			display: flex;
			align-items: center;
			height: 100%;
			z-index: 1000;
		}
		#tabs {
			height: 100%;
			width: 425px;
			background-color: transparent;
			display: flex;
			flex-direction: column;
			flex-wrap: nowrap;
		}
		#hideButton {
			border-color: lightSlateGrey;
			border-left: none;
			border-top-left-radius: 0;
			border-bottom-left-radius: 0;
			padding-left: 6px;
			padding-right: 6px;
		}
		.nav-tabs {
			flex: 0 0 auto;
			border-bottom-color: lightSlateGrey;
		}
		.nav-tabs > li > a {
			padding: 6px 8px 5px 8px;
			background-color: white;
			border-top: 1px solid lightgrey;
			border-right: 1px solid lightgrey;
			border-left: 1px solid lightgrey;
			border-bottom-color: lightSlateGrey;
		}
		.nav-tabs > li.active > a,
		.nav-tabs > li.active > a:hover,
		.nav-tabs > li.active > a:focus {
			border: 1px solid lightSlateGrey;
			border-bottom-color: transparent;
			cursor: default;
		}
		.nav-tabs > li > a:hover {
			border-color: LightSteelBlue ;
			border-bottom-color: lightSlateGrey;
		}
		.tab-content {
			background-color: white;
			border-right: 1px solid lightSlateGrey;
			flex: 1 1 1px;
			overflow: hidden;
		}
		.tab-pane {
			padding: 10px;
			height: 100%;
		}
		.tag-input-group {
			vertical-align: top;
		}
		.tagit {
			list-style-type: none;
		}
		.ui-front {
			z-index: 1001;
		}
		.ui-widget input {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			font-size: 14px;
		}
		.popup-title {
			font-size: 1.2em;
			font-weight: bold;
		}
		.btn {
			padding-left: 6px;
			padding-right: 6px;
		}
		.form-group {
    		margin-bottom: 5px;
		}
		table.popup-table tr td {
			padding: 2px;
			border: 1px solid lightgrey;
			border-collapse: collapse;
		}
		/*table.popup-table tr td.break {
			word-wrap: break-word;
		}*/
		table.popup-table tr td.rowName {
			font-weight: bold;
		}
		.gnsLabel {
			white-space: nowrap;
			/*-webkit-text-stroke: 0.25px white;*/
			font-face: verdana;
			font-weight: bolder;
			font-size: 16px;
			text-shadow:
   				-1px -1px 0 #FFF,
    			1px -1px 0 #FFF,
    			-1px 1px 0 #FFF,
     			1px 1px 0 #FFF;
		}
		#title {
			position: absolute;
			z-index: 999;
			top: 0px;
			left: 50%;
    		transform: translate(-50%,0);
			border: 1px solid lightSlateGrey;
			border-top: none;
			background-color: white;
			border-radius: 0 0 4px 4px;
			padding: 4px 8px 4px 8px;
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-size: 1.2em;
			font-weight: bold;
			color: #445566;
		}
		#routerWrapper {
			display: flex;
			flex-direction: column;
			flex-wrap: nowrap;
			height: 100%;
		}
		#routerList {
			flex: 0 0 auto;
			overflow-y: scroll;
			border: 1px solid LightSteelBlue;
			border-radius: 4px 0px 0px 4px;
			padding: 2px;
			max-height: 40%;
		}
		button.reorder {
			cursor: n-resize;
		}
		#routerControls {
			flex: 0 0 auto;
			display: flex;
			flex-direction: row;
			margin-top: 4px;
			justify-content: flex-start;
			align-items: flex-start;
		}
		.routerControl {
			margin-left: 10px;
			padding: 6px;
			border: 1px solid #CCCCCC;
			border-radius: 4px;
		}
		#directions {
			overflow-y: scroll;
		}
		.direction {
			padding: 5px;
			margin: 2px;
			border: 1px solid #99ff99;
			background-color: #ddffdd;
		}
		.timing {
			margin-top: 8px;
			margin-bottom: 8px;
		}
	</style>
</head>

<body>
	<div id="container">
		<div id="title">DataBC Location Services in Action</div>
		<div id="tabWrapper">
			<div id="tabs">
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active">
						<a href="#tabs-1" aria-controls="tabs-1" role="tab" data-toggle="tab">Address</a>
					</li>
					<li role="presentation">
						<a href="#tabs-2" aria-controls="tabs-2" role="tab" data-toggle="tab">Route</a>
					</li>
					<li role="presentation">
						<a href="#tabs-3" aria-controls="tabs-3" role="tab" data-toggle="tab">Businesses by Tag</a>
					</li>
					<li role="presentation">
						<a href="#tabs-4" aria-controls="tabs-4" role="tab" data-toggle="tab">Businesses by Name</a>
					</li>
				</ul>
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active" id="tabs-1">
						<div class="input-group">
							<input type="text" class="form-control input-field" id="geocodeField" placeholder="Enter civic or intersection address" />
							<div class="input-group-btn">
								<button id="geocodeBtn" class="btn btn-default" type="button" title="Search">
									<span class="glyphicon glyphicon-search" aria-label="Search"></span>
								</button>
								<button id="randomBtn" class="btn btn-default" type="button" title="Jump at Random">
									<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
								</button>
								<button id="gmapsBtn" class="btn btn-default" type="button" title="View in Google Maps">
									<span class="glyphicon glyphicon-globe" aria-label="View in Google Maps"></span>
								</button>
								<button id="addressClear" class="btn btn-default input-clear" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
					</div>
					<div role="tabpanel" class="tab-pane" id="tabs-2">
						<div id="routerWrapper">
							<div id="routerList">
								<div class="form-group">
									<div class="input-group">
										<div class="input-group-btn">
											<button class="btn btn-default reorder" type="button" title="Drag to Re-order">
												<span class="glyphicon glyphicon-sort" aria-label="Drag to Re-order"></span>
											</button>
										</div>
										<input type="text" class="form-control input-field" placeholder="Address" />
										<div class="input-group-btn">
											<button class="btn btn-default random" type="button" title="Random">
												<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
											</button>
											<button class="btn btn-default gmaps" type="button" title="View in Google Maps">
												<span class="glyphicon glyphicon-globe" aria-label="View in Google Maps"></span>
											</button>
											<button class="btn btn-default input-clear" type="button" title="Clear">
												<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
											</button>
										</div>
									</div>
								</div>
								<div class="form-group">
									<div class="input-group">
										<div class="input-group-btn">
											<button class="btn btn-default reorder" type="button" title="Drag to Re-order">
												<span class="glyphicon glyphicon-sort" aria-label="Drag to Re-order"></span>
											</button>
										</div>
										<input type="text" class="form-control input-field" placeholder="Address" />
										<div class="input-group-btn">
											<button class="btn btn-default random" type="button" title="Random">
												<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
											</button>
											<button class="btn btn-default gmaps" type="button" title="View in Google Maps">
												<span class="glyphicon glyphicon-globe" aria-label="View in Google Maps"></span>
											</button>
											<button class="btn btn-default input-clear" type="button" title="Clear">
												<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
											</button>
										</div>
									</div>
								</div>
							</div>
							<div id="routerControls">
								<button id="addDestBtn" class="btn btn-default" type="button" title="Add Destination">
									<span class="glyphicon glyphicon-plus" aria-label="Add Destination"></span>
								</button>
								<div class="routerControl">
									<input name="criteria" type="radio" value="fastest" aria-label="Fastest"  checked="checked"> Fastest<br>
									<input name="criteria" type="radio" value="shortest" aria-label="Shortest"> Shortest
								</div>
								<div class="routerControl not-in-prod"><input id="roundTripChk" type="checkbox" aria-label="Round trip" title="Round trip"> Round Trip</div>
								<div class="routerControl not-in-prod"><input id="optimizeChk" type="checkbox" aria-label="Optimize" title="Optimize"> Optimize</div>
							</div>
							<div id="routerInfo">
								<div id="timing" class="timing"></div>
							</div>
							<div id="directions"></div>
						</div>
					</div>
					<div role="tabpanel" class="tab-pane" id="tabs-3">
						<div class="input-group">
							<ul id="tags"></ul>
							<div class="input-group-btn tag-input-group">
								<button id="findOccsByTag" class="btn btn-default" type="button" title="Search">
									<span class="glyphicon glyphicon-search" aria-label="Search"></span>
								</button>
								<button id="clearTags" class="btn btn-default" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
						Example: Law Courts <span style="font-size: 1.2em;">&crarr;</span>
					</div>
					<div role="tabpanel" class="tab-pane" id="tabs-4">
						<div class="input-group">
							<input type="text" class="form-control" id="nameField" placeholder="Enter name of public place or business" />
							<div class="input-group-btn">
								<button id="findOccsByName" class="btn btn-default" type="button" title="Search">
									<span class="glyphicon glyphicon-search" aria-label="Search"></span>
								</button>
								<button id="nameClear" class="btn btn-default input-clear" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="hideHandle">
				<button id="hideButton" type="button" class="btn btn-default" title="Collapse side panel">
					<span class="glyphicon glyphicon-chevron-left" aria-label="Clear"></span>
				</button>
			</div>
		</div> <!-- tabWrapper -->
		<div id="map"></div>
	</div> <!-- container -->
	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<script src="https://cdn.jsdelivr.net/leaflet.locatecontrol/0.60.0/L.Control.Locate.min.js"></script>
	<script src="leaflet-layerjson.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
	<script src="https://rubaxa.github.io/Sortable/Sortable.js"></script>
	<script src="https://aehlke.github.io/tag-it/js/tag-it.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"></script>
	<script>
		// parse query params
		var queryParams = {};
		location.search.substr(1).split("&").forEach(function(item) {
			var s = item.split("="), k = s[0], v = s[1] && decodeURIComponent(s[1]);
			queryParams[k] = v;
		});

		// API URLs
		var gcApi = "https://apps.gov.bc.ca/pub/geocoder/";
		var routeApi = "https://router.api.gov.bc.ca/";
		if(queryParams['test'] == 'true') {
			gcApi = "https://delivery.apps.gov.bc.ca/pub/geocoder/";
			routeApi = "https://routerdlv.api.gov.bc.ca/";
		} else if(queryParams['test'] == 'rri') {
			gcApi = "https://ssl.refractions.net/ols/pub/geocoder/";
		} else if(queryParams['test'] == 'local') {
			//gcApi = "http://localhost:8080/pub/geocoder/";
			routeApi = "http://localhost:8080/pub/router/";
		} else {
			// hide functions not available from production APIs
			$('.not-in-prod').hide();
		}

		// Leaflet Map setup
		var map = L.map('map', {
			minZoom: 5
		}).setView([48.44, -123.43], 12);
		map.zoomControl.setPosition('bottomright');
		L.control.locate({
			position: 'bottomright',
			icon: 'glyphicon glyphicon-map-marker',
			iconLoading: 'glyphicon glyphicon-time',
			locateOptions: {
				maxZoom: 16
			}
		}).addTo(map);

		var baseLayers = {};
		var overlays = {};

		// define icons to use for markers
		var siteIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/parcelPoint_high.png',
			iconSize: [32,32],
			iconAnchor: [16,16],
			popupAnchor: [0,-10],
		});

		var apIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/accessPoint_high.png',
			iconSize: [32,32],
			iconAnchor: [16,32],
			popupAnchor: [0,-32],
		});

		var intIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/intersectionPoint_high.png',
			iconSize: [32,37],
			iconAnchor: [16,37],
			popupAnchor: [0,-32],
		});

		var occIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/gsr/black_border_32p/bcgsr.unclassified.png',
			iconSize: [26,32],
			iconAnchor: [13,16],
			popupAnchor: [0,-16],
		});

		var redIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});

		var greenIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});

		var mapboxStreetsLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2hvZGdzb24iLCJhIjoiY2oxM3JibHM4MDF3dTJxcDhlcnd1enF5aSJ9.Z_z0AGjZf6P9oh8NWY1JqQ', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		});
		baseLayers['MapBox Streets'] = mapboxStreetsLayer;
		mapboxStreetsLayer.addTo(map);

		var mapboxSatlayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2hvZGdzb24iLCJhIjoiY2oxM3JibHM4MDF3dTJxcDhlcnd1enF5aSJ9.Z_z0AGjZf6P9oh8NWY1JqQ', {
			maxZoom: 18,
			attribution: 'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.satellite'
		});
		baseLayers['MapBox Satellite'] = mapboxSatlayer;

		var bcRoadsBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcgis/services/province/roads_wm/MapServer/WmsServer?',
			{
				layers: '0'
			});
		baseLayers['BC Transportation Base'] = bcRoadsBaseLayer;

		var bcBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcserver/services/province/web_mercator_cache/MapServer/WMSServer?',
			{
				layers: '0'
			});
		baseLayers['BC Base'] = bcBaseLayer;

		var siteLayer = new L.layerJSON({
			url: gcApi + "sites/within.json?excludeUnits=true&brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return siteIcon;
			},
			onEachMarker: function(feature, layer) {
				layer.bindPopup(makePopupText(feature.properties));
				layer.options['title'] = feature.properties.fullAddress;
			}
		});
		overlays["Addresses"] = siteLayer;

		var occLayer = new L.layerJSON({
			url: gcApi + "occupants/within.json?brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 1,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return occIcon;
			},
			onEachMarker: function(feature, layer) {
				layer.bindPopup(makePopupText(feature.properties));
				layer.options['title'] = feature.properties.fullAddress;
			}
		});
		overlays["Businesses"] = occLayer;

		var intLayer = new L.layerJSON({
			url: gcApi + "intersections/within.json?brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return intIcon;
			},
			onEachMarker: function(feature, layer) {
				layer.bindPopup(makePopupText(feature.properties));
				layer.options['title'] = feature.properties.fullAddress;
			}
		});
		overlays["Intersections"] = intLayer;

		var apLayer = new L.layerJSON({
			url: gcApi + "sites/within.json"
				+ "?excludeUnits=true&brief=true&locationDescriptor=accessPoint"
				+ "&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return apIcon;
			},
			onEachMarker: function(feature, layer) {
				layer.bindPopup(makePopupText(feature.properties));
				layer.options['title'] = feature.properties.fullAddress;
			}
		});
		overlays["Addresses – access point "] = apLayer;

		var parcelLayer = L.tileLayer.wms('https://openmaps.gov.bc.ca/geo/pub/WHSE_CADASTRE.CBM_CADASTRAL_FABRIC_PUB_SVW/ows?SERVICE=WMS&',
			{
				layers: 'pub:WHSE_CADASTRE.CBM_CADASTRAL_FABRIC_PUB_SVW',
				transparent: true,
				format: 'image/png'
			});
		parcelLayer.addTo(map);
		overlays['Parcels'] = parcelLayer;

		var draLayer = L.tileLayer.wms('http://openmaps.gov.bc.ca/geo/ows?',
			{
				layers: 'pub:WHSE_BASEMAPPING.DRA_DGTL_ROAD_ATLAS_MPAR_SP',
				transparent: true,
				format: 'image/png'
			});
		overlays['BC Digital Road Atlas'] = draLayer;

		// var gnsLayer = L.tileLayer.wms('http://test.openmaps.gov.bc.ca/geo/pub/WHSE_BASEMAPPING.GNS_GEOGRAPHICAL_NAMES_SP/ows?',
		// 	{
		// 		layers: 'pub:WHSE_BASEMAPPING.GNS_GEOGRAPHICAL_NAMES_SP',
		// 		transparent: true,
		// 		format: 'image/png'
		// 	});
		var gnsLayer = new L.layerJSON({
			url: "http://apps.gov.bc.ca/pub/bcgnws/names/official/inside"
				+ "?itemsPerPage=50&sortBy=name&outputFormat=json&outputSRS=4326"
				+ "&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 12,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.uri",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return apIcon;
			},
			buildIcon: function(data, title) {	// make icon from data
				return L.divIcon({html: data.properties.name, className: "gnsLabel"});
			},
			onEachMarker: function(feature, layer) {
				//layer.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays['BC Geographical Names'] = gnsLayer;

		var layerControl = L.control.layers(baseLayers, overlays).addTo(map);

		// tabs UI setup
		$('#myTabs a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});

 		$('div.input-group').on('click', 'button.input-clear', function(evt) {
			$(this).parents('div.input-group').find('input.input-field').val('');
		});

		function makePopupText(props) {
			var str = '<span class="popup-title">' + props.fullAddress
					+ '</span><table class="popup-table">';

			if(props.score) {
				str += '<tr><td class="rowName">Score:</td><td>' + props.score + '</td></tr>';
				str += '<tr><td class="rowName">Match Precision:</td><td>' + props.matchPrecision + '</td></tr>';
				str += '<tr><td class="rowName">Precision Points:</td><td>' + props.precisionPoints + '</td></tr>';
				str += '<tr><td class="rowName">Faults:</td><td><table class="popup-table">';
				for(var i = 0, len = props.faults.length; i < len; i++) {
					var f = props.faults[i];
					str += '<tr><td class="rowName">' + f.element + '.' + f.fault + '</td><td>' + f.penalty + '</td></tr>';
				}
				str += '</table></td></tr>';
			}

			if(props.degree) {
				str += '<tr><td class="rowName">Degree:</td><td>' + props.degree + '</td></tr>';
			}

			if(props.occupantName) {
				str += '<tr><td class="rowName">Image URL</td><td>';
				if(props.imageUrl) {
					str += '<img url="' + props.imageUrl + '"/>';
				} else {
					str += 'No Image';
				}
				str	+= '</td></tr>';
				str += '<tr><td class="rowName">Occupant Description</td><td>' + props.occupantDescription + '</td></tr>';
				str += '<tr><td class="rowName">Website Url</td><td>' + props.websiteUrl.replace(/\//g, '/<wbr>') + '</td></tr>';
				str += '<tr><td class="rowName">Contact E-mail</td><td>' + props.contactEmail + '</td></tr>';
				str += '<tr><td class="rowName">Contact Phone</td><td>' + props.contactPhone + '</td></tr>';
				str += '<tr><td class="rowName">Contact Fax</td><td>' + props.contactFax + '</td></tr>';
				str += '<tr><td class="rowName">Keywords</td><td>' + props.keywords.replace(/;/g, ';<wbr>') + '</td></tr>';
				str += '<tr><td class="rowName">Business Category Class</td><td>' + props.businessCategoryClass + '</td></tr>';
				str += '<tr><td class="rowName">NAICS Code</td><td>' + props.naicsCode + '</td></tr>';
			}

			str += '</table>';
			return str;
		}

		// reusable function for suggesting geocode autocompletion options
		function geocodeSuggest(request, response, options) {
			var params = {
				minScore: 50,
				maxResults: 5,
				echo: 'false',
				brief: true,
				autoComplete: true,
				addressString: request.term
			};
			$.extend(params, options);
			$.ajax({
				url: gcApi + "addresses.json",
				data: params,
				success: function(data) {
					var list = [];
					if(data.features && data.features.length > 0) {
						list = data.features.map( function(item) {
							return {
								value: item.properties.fullAddress,
								data: item
							}
						});
					}
					response(list);
				},
				error: function() {
					response([]);
				}
			});
		}

		// function to convert json or a latlng into a layer and put it on the map
		function receiveGeocode(data, center=true) {
			var layer;
			if(data instanceof L.LatLng) {
				layer = latLngToLayer(data);
			} else {
				layer = L.geoJson(data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText(feature.properties));
						layer.bindTooltip(feature.properties.fullAddress, {
								permanent: true
							}).openTooltip();
					}
				});
			}
			if(geocodeLayer) {
				map.removeLayer(geocodeLayer);
			}
			geocodeLayer = layer;
			layer.addTo(map);
			centerMap(geocodeLayer.getBounds(), center);

		}

		// Geocode Address autocomplete
		$('#geocodeField').autocomplete({
			minLength: 3,
			source: geocodeSuggest,
			select: function(evt, ui) {
				receiveGeocode(ui.item.data);
			}
		});

		var geocodeLayer = null;

		// Geocode Address event handler
		function geocode($field, callback) {
			var latLng = isCoords($field.val());
			if(latLng) {
				callback(latLng);
			} else {
				$.ajax({
					url: gcApi + "addresses.json",
					data: {
						echo: 'false',
						brief: true,
						addressString: $field.val()
					},
					success: callback,
					error: function(request) {
						alert("error loading geocode results.");
						console.log(request);
					}
				});
			}
		}

		$('#geocodeField').keypress(function(e) {
 			if(e.which == 13) {
    			geocode($('#geocodeField'), receiveGeocode);
    			return false;
  			}
		});

		$('#geocodeBtn').on("click", function() {
			geocode($('#geocodeField'), receiveGeocode);
		});

		$('#randomBtn').on("click", function() {
			randomAddress($('#geocodeField'), 'parcelPoint', function(data) {
				receiveGeocode(data, false);
			});
		});

		$('#gmapsBtn').on("click", function() {
			window.open('http://maps.google.com/?q=' + $('#geocodeField').val());
		});

		$('#addressClear').on("click", function() {
			if(geocodeLayer) {
				map.removeLayer(geocodeLayer);
				geocodeLayer = null;
			}
		});

		// Routing
		var routeLayer;
		var routeRequest;

		function getRouteIcon(index) {
			if(index == 0) {
				return greenIcon;
			}
			return redIcon;
		}

		function clearRoute() {
			$('#timing').empty();
			$('#directions').empty();
			if(routeLayer) {
				map.removeLayer(routeLayer);
				routeLayer = null;
			}
		}

		function route($field, center = true) {
			// test will be an empty string if all inputs have a point
			var test = $('#routerList input.input-field').map( function(index, element) {
				if( $(element).data('marker') ) {
					return "";
				}
				return "1";
			}).get().join("");
			if(test != "") {
				if($field && center) {
					map.panTo($field.data('marker').getLayers()[0].getLatLng());
				}
				return;
			}
			clearRoute();
			$('#timing').html('Calculating Route...');

			var points = $('#routerList input.input-field').map( function(index, element) {
				var latLng = $(element).data('marker').getLayers()[0].getLatLng();
				return latLng.lng + "," + latLng.lat;
			}).get().join(',');

			var criteria = $('input[name=criteria]:checked').val();

			var query = 'directions.json';
			if($('#optimizeChk').is(':checked')) {
				query = 'optimalDirections.json';
			}

			var roundTrip = 'false';
			if($('#roundTripChk').is(':checked')) {
				roundTrip = 'true';
			}

			if(routeRequest != null) {
				routeRequest.abort();
			}
			routeRequest = $.ajax({
				url: routeApi + query,
				data: {
					apikey: "11dd756f680c47b5aef5093d95543738",
					criteria: criteria,
					roundTrip: roundTrip,
					points: points
				},
				success: function(data) {
					clearRoute();
					routeLayer = L.geoJson({
							type: "Feature",
							properties: {},
							geometry: {
								type: "LineString",
								coordinates: data.route
							}
						}, {
						onEachFeature: function(feature, layer) {
							layer.options['title'] = "fastest";
							layer.setStyle({color:"#FF00FF", weight:7, opacity: 0.5});
						}
					}).addTo(map);
					centerMap(routeLayer.getBounds(), center);

					$('#timing').html('Route travels ' + data.distance + ' km in ' + data.timeText + '<br\>Directions:');
					var dirs = data.directions;
					for(i = 0; i < dirs.length; i++) {
						if(dirs[i].text) {
							var $dir = $("<div class=\"direction\">" + dirs[i].text + "</div>");
							$('#directions').append($dir);
							$dir.data('latlng', {'lat': dirs[i].point[1], 'lng': dirs[i].point[0]}) ;
						} else {
							$('#directions').append("<div class=\"direction\">" + dirs[i] + "</div>");
						}
					}
				},
				error: function(request) {
					if(request.statusText != "abort") {
						alert("error loading route results.");
						console.log(request);
					}
				}
			});
		}

		Sortable.create(document.getElementById('routerList'),{
			handle: ".reorder",
			draggable: ".form-group",
			onUpdate: function(evt) {
				route(null);
			}
		});

		// press enter on router field
		$('#routerList').on('keypress', 'input.input-field', function(e) {
			if(e.which == 13) {
				var latLng = isCoords($(this).val());
				if(latLng) {
    				receiveRouteGeocode(latLng, $(this));
				}
    			return false;
  			}
		});

		// pick random location button
		$('#routerList').on('click', 'button.random', function() {
			randomAddress($(this).parents('div.form-group').find('input.input-field'), 'accessPoint', function(data, $field) {
				receiveRouteGeocode(data, $field, false);
			});
		});

		// open in gmaps button
		$('#routerList').on('click', 'button.gmaps', function() {
			window.open('http://maps.google.com/?q='
					+ $(this).parents('div.form-group').find('input.input-field').val());
		});

		// clear router input field button
		$('#routerList').on('click', 'button.input-clear', function() {
			clearRoute();
			var $inputField = $(this).parents('div.input-group').find('input.input-field');
			var marker = $inputField.data('marker');
			if(marker) {
				map.removeLayer(marker);
			}
			// if there are more than 2 destinations
			if($('#routerList > div.form-group').size() > 2) {
				// delete this destination field and route the remaining fields
				$(this).parents('div.form-group').remove();
				route(null);
			} else {
				// must leave at least 2 fields, just clear this field
				$inputField.val('');
				$inputField.data('marker', null);
			}
		});

		// add destination button
		$('#addDestBtn').on('click', function() {
			$formGroup = $('#routerList > .form-group:first-child').clone().appendTo('#routerList');
			$input = $formGroup.find('input.input-field');
			$input.val('');
			$input.data('marker', null);
			$input.autocomplete({
				minLength: 3,
				source: function(request, response) {
					geocodeSuggest(request, response, {
						locationDescriptor: 'accessPoint'
					});
				},
				select: function(evt, ui) {
					receiveRouteGeocode(ui.item.data, $(evt.target));
				}
			});
			$formGroup[0].scrollIntoView(false);
		});
		$('input[name=criteria]').on('change', function(evt) {
			route(null, false);
		});

		$('#roundTripChk').on('change', function(evt) {
			route(null, false);
		});

		$('#optimizeChk').on('change', function(evt) {
			route(null, false);
		});

		var directionMarker = null;

		$('#directions').on('mouseenter', 'div.direction', function(evt) {
			if(directionMarker != null) {
				map.removeLayer(directionMarker);
			}
			var latlng = $(evt.target).data('latlng');
			if(latlng) {
				directionMarker = L.circleMarker(latlng).addTo(map);
			}
		});

		$('#directions').on('mouseleave', 'div.direction', function(evt) {
			if(directionMarker != null) {
				map.removeLayer(directionMarker);
			}
		});

		function receiveRouteGeocode(data, $field, center = true) {
			var layer, latLng;
			var pos = $field.parents('div.form-group').index();
			var icon = getRouteIcon(pos);
			if(data instanceof L.LatLng) {
				latLng = data;
				layer = latLngToLayer(data, {icon: icon});
			} else {
				// sort out whether we have a single feature or a featureCollection
				var feature = data;
				if(data.features) {
					feature = data.features[0];
				}
				$field.val(feature.properties.fullAddress);
				latLng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
				layer = L.geoJson(data, {
					pointToLayer: function (feature, latlng) {
						return L.marker(latlng, {icon: icon});
					},
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText({'fullAddress': feature.properties['fullAddress']}));
						layer.bindTooltip(feature.properties.fullAddress, {
								permanent: true
							}).openTooltip();
					}
				});
			}
			var oldMarker = $field.data('marker');
			if(oldMarker) {
				map.removeLayer(oldMarker);
			}
			$field.data('marker', layer);
			layer.addTo(map);
			route($field, center);
		}

		// Routing - Address autocomplete
		$('#routerList input.input-field').autocomplete({
			minLength: 3,
			source: function(request, response) {
				geocodeSuggest(request, response, {
					locationDescriptor: 'accessPoint'
				});
			},
			select: function(evt, ui) {
				receiveRouteGeocode(ui.item.data, $(evt.target));
			}
		});

		var occsByTagLayer;

		// Tag-it setup (including autocomplete) for Occupants by tag
		$('#tags').tagit({
			allowSpaces: true,
			autocomplete: {
				source: function(request, response) {
					$.ajax({
						url: gcApi + "occupants/tags.json",
						data: {tag: request.term},
						success: response,
						error: function() {
							response([]);
						}
					});
				}
			}
		});

		$('.tagit-new > input').attr('placeholder', 'Enter tags');

		// Find nearby Occupants by Tag event handler
		$('#findOccsByTag').on("click", function() {
			if(occsByTagLayer) {
				map.removeLayer(occsByTagLayer);
				occsByTagLayer = null;
			}
			var tagList = $('#tags').tagit("assignedTags").join(";");
			occsByTagLayer = new L.layerJSON({
				url: gcApi + "occupants/within.json?tags=" + tagList + "&bbox={lon1},{lat1},{lon2},{lat2}",
				caching: false,
				propertyItems: "features",
				propertyId: "properties.fullAddress",
				locAsGeoJSON: true,
				propertyLoc: "geometry.coordinates",
				buildIcon: function() {
					return occIcon;
				},
				onEachMarker: function(feature, layer) {
					layer.bindPopup(makePopupText(feature.properties));
					layer.options['title'] = feature.properties.fullAddress;
				}
			});
			occsByTagLayer.addTo(map);
		});

		$('#clearTags').on('click', function() {
			$('#tags').tagit('removeAll');
			if(occsByTagLayer) {
				map.removeLayer(occsByTagLayer);
				occsByTagLayer = null;
			}
		})

		// Find Occupants By Name Autocomplete
		$('#nameField').autocomplete({
			minLength: 4,
			source: function(request, response) {
				$.ajax({
					url: gcApi + "occupants/addresses.json",
					data: {
						minScore: 50,
						maxResults: 5,
						echo: false,
						autoComplete: true,
						brief: true,
						addressString: request.term + "--"
					},
					success: function(data) {
						var list = [];
						if(data.features && data.features.length > 0) {
							list = data.features.map( function(item) {
								return {
									value: item.properties.fullAddress,
									data: item
								};
							});
						}
						response(list);
					},
					error: function() {
						response([]);
					}
				});
			},
			select: function(evt,ui) {
				if(namedOccLayer) {
					map.removeLayer(namedOccLayer);
				}
				namedOccLayer = L.geoJson(ui.item.data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText(feature.properties));
						layer.options['title'] = feature.properties.fullAddress;
					}
				}).addTo(map);
				centerMap(namedOccLayer.getBounds());
			}
		});

		var namedOccLayer;

		// Find Occupants By Name event handler
		function findOccs($field) {
			var addr = $field.val();
			if(addr.indexOf("--") == -1) {
				addr += " --";
			}
			$.ajax({
				url: gcApi + "occupants/addresses.json",
				data: {
					echo: 'false',
					brief: true,
					addressString: addr
				},
				success: function(data) {
					if(namedOccLayer) {
						map.removeLayer(namedOccLayer);
						namedOccLayer = null;
					}
					namedOccLayer = L.geoJson(data, {
						onEachFeature: function(feature, layer) {
							layer.bindPopup(makePopupText(feature.properties));
							layer.options['title'] = feature.properties.fullAddress;
						}
					}).addTo(map);
					centerMap(namedOccLayer.getBounds());
				},
				error: function(request) {
					alert("Error loading occupants by name.");
					console.log(request);
				}
			});
		};

		$('#nameField').keypress(function(e) {
			if(e.which == 13) {
				findOccs($('#nameField'));
				return false;
			}
		});

		$('#findOccsByName').on("click", function() {
			findOccs($('#nameField'));
		});

		$('#nameClear').on('click', function() {
			if(namedOccLayer) {
				map.removeLayer(namedOccLayer);
				namedOccLayer = null;
			}
		});

		var tabs = true;
		$('#hideButton').on('click', function() {
			if(tabs) {
				$('#tabWrapper').animate({
					left: -425
				}, 425, "swing", function() {
					$('#hideButton').attr('title', 'Expand side panel');
					$('#hideButton span').removeClass('glyphicon-chevron-left');
					$('#hideButton span').addClass('glyphicon-chevron-right');
					tabs = false;
					map.invalidateSize();
				});
			} else {
				$('#tabWrapper').animate({
					left: 0
				}, 425, "swing", function() {
					$('#hideButton').attr('title', 'Collapse side panel');
					$('#hideButton span').removeClass('glyphicon-chevron-right');
					$('#hideButton span').addClass('glyphicon-chevron-left');
					tabs = true;
					map.invalidateSize();
				});
			}
		});

		function isCoords(input) {
			var matches = input.match(/^\s*(-?\d{1,3}(?:\.\d*)?)\s*,\s*(-?[0-9]{1,3}(?:\.\d*)?)\s*$/);
			if(matches != null) {
				var lat = matches[1];
				var lng = matches[2];
				if(lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
					return new L.latLng(lat,lng);
				}
			}
			return false;
		}

		// Random Address event handler
		function randomAddress($field, locationDescriptor, callback) {
			var bounds = map.getBounds();
			var height = bounds.getNorth() - bounds.getSouth()
			var lat = (Math.random() * height * 0.8) + bounds.getSouth() + (height * 0.1);
			var west = bounds.getWest();
			if(tabs) {
				var west = map.containerPointToLatLng([400,0]).lng;
			}
			var width = bounds.getEast() - west;
			var lng = (Math.random() * width * 0.8) + west + (width * 0.1);
			$.ajax({
				url: gcApi + "sites/nearest.json",
				data: {
					locationDescriptor: locationDescriptor,
					excludeUnits: true,
					onlyCivic: true,
					brief: true,
					point: lng + "," + lat
				},
				success: function(data) {
					$field.val(data.properties.fullAddress);
					return callback(data, $field);
				},
				error: function(request) {
					alert("error finding nearest site to random point.");
					console.log(request);
				}
			});
		}

		function latLngToLayer(latLng, markerOptions) {
			var marker = L.marker(latLng, markerOptions);
			marker.bindPopup('<span class="popup-title">' + latLng.lat + "," + latLng.lng + '</span>');
			var layer = L.featureGroup([marker]);
			return layer;
		}

		function centerMap(bounds, center = true) {
			if(center) {
				var options = {
					maxZoom: 16
				};
				if(tabs) {
					options.paddingTopLeft = [400,0];
				}
				map.fitBounds(bounds.pad(0.25), options);
			} else if(!map.getBounds().contains(bounds.pad(0.25))) {
				// if the bounds aren't within the current map bounds
				// zoom out to include the bounds
				map.fitBounds(bounds.extend(map.getBounds()).pad(0.25));
			}
		}

		if(queryParams['q']) {
			$('#geocodeField').val(queryParams['q']);
			geocode($('#geocodeField'), receiveGeocode);
		}
	</script>
</body>
</html>
