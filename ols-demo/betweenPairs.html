<!DOCTYPE html>
<html lang="en">

<head>
	<title>Router BetweenPairs Demo - DataBC Location Services</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
	<style>
		html, body {
            height: 100%;
            width: 100%;
        }
		body {
            padding: 0;
            margin: 0;
		}
		#container {
			display: flex;
			flex-direction: column;
			height: 100%;
            width: 100%;
			overflow: hidden;
		}
		#upperContainer {
			display: flex;
			flex-direction: row;
			height: 60%;
		}
		#inputDiv {
			height: 100%;
			width: 50%;
			margin: 10px;
		}
		#map {
			height: 100%;
            width: 50%;
        }
		#outputDiv {
			display: flex;
			flex-direction: column;
			height: 40%;
			margin: 10px;
		}
		#results {
			overflow: scroll;
		}
		.ui-front {
			z-index: 1001;
		}
		.ui-widget input {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			font-size: 14px;
		}
		.popup-title {
			font-size: 1.2em;
			font-weight: bold;
		}
		.btn {
			padding-left: 6px;
			padding-right: 6px;
		}
		.form-group {
    		margin-bottom: 5px;
		}
		table.popup-table tr td {
			padding: 2px;
			border: 1px solid lightgrey;
			border-collapse: collapse;
		}
		table.popup-table tr td.rowName {
			font-weight: bold;
		}
		.gnsLabel {
			white-space: nowrap;
			/*-webkit-text-stroke: 0.25px white;*/
			font-face: verdana;
			font-weight: bolder;
			font-size: 16px;
			text-shadow:
   				-1px -1px 0 #FFF,
    			1px -1px 0 #FFF,
    			-1px 1px 0 #FFF,
     			1px 1px 0 #FFF;
		}
		#addressLists {
			width: 100%;
			height: 60%;
			display: flex;
			flex-direction: row;
		}
		.listWrapper {
			height: 100%;
			width: 50%;
			display: flex;
			flex-direction: column;
		}
		.listLabel {
			flex: none;
		}
		.addressList {
			flex: 1 1 auto;
			overflow-y: scroll;
			border: 1px solid LightSteelBlue;
			padding: 2px;
		}
		button.reorder {
			cursor: n-resize;
		}
		.controls {
			flex: 0 0 auto;
			display: flex;
			flex-direction: row;
			margin-top: 4px;
			justify-content: flex-start;
			align-items: baseline;
		}
		.control {
			margin-left: 10px;
			padding: 6px;
			border: 1px solid #CCCCCC;
			border-radius: 4px;
		}
		.mainControls {
			flex: 0 0 auto;
			display: flex;
			flex-direction: row;
			margin: 20px;
			justify-content: center;
			align-items: center;
		}
		.numAdd {
			width: 40px;
		}
		#maxPairs {
			width: 40px;
		}
		.timing {
			margin-top: 8px;
			margin-bottom: 8px;
		}
		span.fastest {
			color: #FF00FF;
		}
		span.shortest {
			color: #0000FF;
		}
		.leaflet-marker-icon .number {
			position: relative;
			top: -36px;
			font-size: 11px;
			font-family: "Arial Narrow", Arial, sans-serif;
			font-weight: bold;
			width: 25px;
			text-align: center;
		}

		/* For leaflet-history.js */
		.history-control.leaflet-bar.hidden{display:none}
		.history-control.leaflet-bar.horizontal a{display:inline-block;border-bottom:0;border-radius:0;border-right:1px solid #ccc}
		.history-control.leaflet-bar.horizontal a:first-child{border-top-left-radius:4px;border-bottom-left-radius:4px}
		.history-control.leaflet-bar.horizontal a:last-child{border-top-right-radius:4px;border-bottom-right-radius:4px;border-right:0}
		.history-control.leaflet-bar a{width:auto;font-size:1.1em;min-width:26px}
	</style>
</head>

<body>
	<div id="container">
		<div id="upperContainer">
			<div id="inputDiv">
				<h1>BetweenPairs Demo</h1>
				<div id="addressLists">
					<div class="listWrapper">
						<div class="listLabel">From Points:</div>
						<div id="fromList" class="addressList">
							<div class="form-group">
								<div class="input-group">
									<div class="input-group-btn">
										<button class="btn btn-default reorder" type="button" title="Drag to Re-order">
											<span class="glyphicon glyphicon-sort" aria-label="Drag to Re-order"></span>
										</button>
									</div>
									<input type="text" class="form-control input-field" placeholder="Address" />
									<div class="input-group-btn">
										<button class="btn btn-default random" type="button" title="Jump at Random">
											<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
										</button>
										<button class="btn btn-default zoom-to" type="button" title="Zoom To Location">
											<span class="glyphicon glyphicon-map-marker" aria-label="Zoom To Location"></span>
										</button>
										<button class="btn btn-default input-clear" type="button" title="Clear">
											<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
										</button>
									</div>
								</div>
							</div>
						</div>
						<div class="controls">
							<button class="btn btn-default addAddrBtn" type="button" title="Add From Point">
								<span class="glyphicon glyphicon-plus" aria-label="Add From Point"></span>
							</button>
							<input type="text" class="form-control input-field numAdd" value="1" />
							&nbsp; Random Points within Map view
						</div>
					</div>
					<div class="listWrapper">
						<div class="listLabel">To Points:</div>
						<div id="toList" class="addressList"></div>
						<div class="controls">
							<button class="btn btn-default addAddrBtn" type="button" title="Add To Point">
								<span class="glyphicon glyphicon-plus" aria-label="Add To Point"></span>
							</button>
							<input type="text" class="form-control input-field numAdd" value="1" />
							&nbsp; Random Points within Map view
						</div>
					</div>
				</div>
				<div class="mainControls">
					<div class="control">
						<input name="criteria" type="radio" value="fastest" aria-label="Fastest"  checked="checked"> <span class="fastest">Fastest</span><br>
						<input name="criteria" type="radio" value="shortest" aria-label="Shortest"> <span class="shortest">Shortest</span>
					</div>
					&nbsp;
					<div class="control">
						<form class="form-inline">
  							<div class="form-group">
								<input id="maxPairsChk" type="checkbox" title="Enable MaxPairs">
								MaxPairs
								<input id="maxPairs" type="text" class="form-control" value="1" />
							</div>
						</form>
					</div>
					&nbsp;
					<button id="execute" class="btn btn-default" type="button" title="Execute">
						Execute
					</button>
				</div>
			</div>
			<div id="map"></div>
		</div>
		<div id="outputDiv">
			<div id="timing" class="timing"></div>
			<div id="results"></div>
		</div>
	</div> <!-- container -->
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
	<script src="leaflet-layerjson.js"></script>
	<script src="leaflet-history.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
	<script src="https://rubaxa.github.io/Sortable/Sortable.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"></script>
	<script>
		L.NumberedIcon = L.Icon.extend({
			options: {
    			number: '',
				iconUrl: 'img/marker-icon-hole.png',
    			iconSize: new L.Point(25, 41),
				iconAnchor: new L.Point(13, 41),
				popupAnchor: new L.Point(0, -33),
				shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
				shadowSize: [41, 41]
			},

			createIcon: function () {
				var div = document.createElement('div');
				var img = this._createImg(this.options['iconUrl']);
				var numdiv = document.createElement('div');
				numdiv.setAttribute ( "class", "number" );
				numdiv.innerHTML = this.options['number'] || '';
				div.appendChild ( img );
				div.appendChild ( numdiv );
				this._setIconStyles(div, 'icon');
				return div;
			},

		});

		// parse query params
		var queryParams = {};
		location.search.substr(1).split("&").forEach(function(item) {
			var s = item.split("="), k = s[0], v = s[1] && decodeURIComponent(s[1]);
			queryParams[k] = v;
		});

		// API URLs
		var apiKey = "11dd756f680c47b5aef5093d95543738";
		var gcApi = "https://apps.gov.bc.ca/pub/geocoder/";
		var routeApi = "https://router.api.gov.bc.ca/";
		var routeMethod = 'POST';
		if(queryParams['env'] == 'tst') {
			gcApi = "https://test.apps.gov.bc.ca/pub/geocoder/";
			routeApi = "https://routertst.api.gov.bc.ca/";
		} else if(queryParams['env'] == 'dlv') {
			gcApi = "https://delivery.apps.gov.bc.ca/pub/geocoder/";
			routeApi = "https://routerdlv.api.gov.bc.ca/";
		} else if(queryParams['env'] == 'rri') {
			gcApi = "https://ssl.refractions.net/ols/pub/geocoder/";
		} else if(queryParams['env'] == 'lg') {
			gcApi = "http://localhost:8080/pub/geocoder/";
		} else if(queryParams['env'] == 'lr') {
			routeApi = "http://localhost:8080/pub/router/";
		} else {
			routeMethod = 'GET';
			// hide functions not available from production APIs
			$('.not-in-prod').hide();
		}

		// Leaflet Map setup
		var map = L.map('map', {
			minZoom: 5,
			maxZoom: 18
		}).setView([48.44, -123.43], 12);
		new L.HistoryControl({
			position: 'bottomright',
    		backImage: 'glyphicon glyphicon-triangle-left',
    		forwardImage: 'glyphicon glyphicon-triangle-right'
		}).addTo(map);
		map.zoomControl.setPosition('bottomright');

		var baseLayers = {};
		var overlays = {};

		// define icons to use for markers
		var siteIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/parcelPoint_high.png',
			iconSize: [32,32],
			iconAnchor: [16,16],
			popupAnchor: [0,-10],
		});

		var apIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/accessPoint_high.png',
			iconSize: [32,32],
			iconAnchor: [16,32],
			popupAnchor: [0,-32],
		});

		var intIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/intersectionPoint_high.png',
			iconSize: [32,37],
			iconAnchor: [16,37],
			popupAnchor: [0,-32],
		});

		var occIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/gsr/black_border_32p/bcgsr.unclassified.png',
			iconSize: [26,32],
			iconAnchor: [13,16],
			popupAnchor: [0,-16],
		});

		var redIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});

		var greenIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});

		var baseErrorMsg = "An unexpected server error occurred; No response from server.\n";

		var mapboxStreetsLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2hvZGdzb24iLCJhIjoiY2oxM3JibHM4MDF3dTJxcDhlcnd1enF5aSJ9.Z_z0AGjZf6P9oh8NWY1JqQ', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		});
		baseLayers['MapBox Streets'] = mapboxStreetsLayer;
		mapboxStreetsLayer.addTo(map);

		var mapboxSatlayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2hvZGdzb24iLCJhIjoiY2oxM3JibHM4MDF3dTJxcDhlcnd1enF5aSJ9.Z_z0AGjZf6P9oh8NWY1JqQ', {
			maxZoom: 18,
			attribution: 'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.satellite'
		});
		baseLayers['MapBox Satellite'] = mapboxSatlayer;

		var bcRoadsBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcgis/services/province/roads_wm/MapServer/WmsServer?',
			{
				layers: '0'
			});
		baseLayers['BC Transportation Base'] = bcRoadsBaseLayer;

		var bcBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcserver/services/province/web_mercator_cache/MapServer/WMSServer?',
			{
				layers: '0'
			});
		baseLayers['BC Base'] = bcBaseLayer;

		var siteLayer = new L.layerJSON({
			url: gcApi + "sites/within.json?excludeUnits=true&brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return siteIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}

		});
		overlays["Addresses - parcel point"] = siteLayer;

		var apLayer = new L.layerJSON({
			url: gcApi + "sites/within.json"
				+ "?excludeUnits=true&brief=true&locationDescriptor=accessPoint"
				+ "&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return apIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays["Addresses – access point "] = apLayer;

		var occLayer = new L.layerJSON({
			url: gcApi + "occupants/within.json?brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 1,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return occIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays["Businesses"] = occLayer;

		var intLayer = new L.layerJSON({
			url: gcApi + "intersections/within.json?brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return intIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays["Intersections"] = intLayer;

		var parcelLayer = L.tileLayer.wms('https://openmaps.gov.bc.ca/geo/pub/WHSE_CADASTRE.CBM_CADASTRAL_FABRIC_PUB_SVW/ows?SERVICE=WMS&',
			{
				layers: 'pub:WHSE_CADASTRE.CBM_CADASTRAL_FABRIC_PUB_SVW',
				transparent: true,
				format: 'image/png'
			});
		parcelLayer.addTo(map);
		overlays['Parcels'] = parcelLayer;

		var draLayer = L.tileLayer.wms('http://openmaps.gov.bc.ca/geo/ows?',
			{
				layers: 'pub:WHSE_BASEMAPPING.DRA_DGTL_ROAD_ATLAS_MPAR_SP',
				transparent: true,
				format: 'image/png'
			});
		overlays['BC Digital Road Atlas'] = draLayer;

		var gnsLayer = new L.layerJSON({
			url: "https://apps.gov.bc.ca/pub/bcgnws/names/official/inside"
				+ "?itemsPerPage=50&sortBy=name&outputFormat=json&outputSRS=4326"
				+ "&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 9,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.uri",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return apIcon;
			},
			buildIcon: function(data, title) {	// make icon from data
				return L.divIcon({html: data.properties.name, className: "gnsLabel"});
			},
			onEachMarker: function(feature, layer) {
				//layer.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays['BC Geographical Names'] = gnsLayer;

		var layerControl = L.control.layers(baseLayers, overlays).addTo(map);

		function makePopupText(props) {
			var str = '<span class="popup-title">' + props.fullAddress
					+ '</span><table class="popup-table">';

			if(props.score) {
				str += '<tr><td class="rowName">Score:</td><td>' + props.score + '</td></tr>';
				str += '<tr><td class="rowName">Match Precision:</td><td>' + props.matchPrecision + '</td></tr>';
				str += '<tr><td class="rowName">Precision Points:</td><td>' + props.precisionPoints + '</td></tr>';
				str += '<tr><td class="rowName">Faults:</td><td><table class="popup-table">';
				for(var i = 0, len = props.faults.length; i < len; i++) {
					var f = props.faults[i];
					str += '<tr><td class="rowName">' + f.element + '.<wbr>' + f.fault + '</td><td>' + f.penalty + '</td></tr>';
				}
				str += '</table></td></tr>';
			}

			if(props.degree) {
				str += '<tr><td class="rowName">Degree:</td><td>' + props.degree + '</td></tr>';
			}

			if(props.occupantName) {
				str += '<tr><td class="rowName">Image URL</td><td>';
				if(props.imageUrl) {
					str += '<img url="' + props.imageUrl + '"/>';
				} else {
					str += 'No Image';
				}
				str	+= '</td></tr>';
				str += '<tr><td class="rowName">Occupant Description</td><td>' + props.occupantDescription + '</td></tr>';
				str += '<tr><td class="rowName">Website Url</td><td>' + props.websiteUrl.replace(/\//g, '/<wbr>') + '</td></tr>';
				str += '<tr><td class="rowName">Contact E-mail</td><td>' + props.contactEmail + '</td></tr>';
				str += '<tr><td class="rowName">Contact Phone</td><td>' + props.contactPhone + '</td></tr>';
				str += '<tr><td class="rowName">Contact Fax</td><td>' + props.contactFax + '</td></tr>';
				str += '<tr><td class="rowName">Keywords</td><td>' + props.keywords.replace(/;/g, ';<wbr>') + '</td></tr>';
				str += '<tr><td class="rowName">Business Category Class</td><td>' + props.businessCategoryClass + '</td></tr>';
				str += '<tr><td class="rowName">NAICS Code</td><td>' + props.naicsCode + '</td></tr>';
			}

			str += '</table>';
			return str;
		}

		// reusable function for suggesting geocode autocompletion options
		function geocodeSuggest(request, response, options) {
			var params = {
				minScore: 50,
				maxResults: 5,
				echo: 'false',
				brief: true,
				autoComplete: true,
				addressString: request.term
			};
			$.extend(params, options);
			$.ajax({
				url: gcApi + "addresses.json",
				data: params,
				success: function(data) {
					var list = [];
					if(data.features && data.features.length > 0) {
						list = data.features.map( function(item) {
							return {
								value: item.properties.fullAddress,
								data: item
							}
						});
					}
					response(list);
				},
				error: function() {
					response([]);
				}
			});
		}

		var betweenPairsLayer;
		var betweenPairsRequest;

		function clearBetweenPairs() {
			$('#timing').empty();
			$('#results').empty();
			if(betweenPairsLayer) {
				map.removeLayer(betweenPairsLayer);
				betweenPairsLayer = null;
			}
		}

		function betweenPairs() {
			// test will be an empty string if all inputs have a point
			clearBetweenPairs();
			$('#timing').html('Calculating Between Pairs...');

			var params = {};

			params['fromPoints'] = $('#fromList input.input-field').map( function(index, element) {
				var latLng = $(element).data('marker').getLayers()[0].getLatLng();
				return latLng.lng + "," + latLng.lat;
			}).get().join(',');

			params['toPoints'] = $('#toList input.input-field').map( function(index, element) {
				var latLng = $(element).data('marker').getLayers()[0].getLatLng();
				return latLng.lng + "," + latLng.lat;
			}).get().join(',');

			params['criteria'] = $('input[name=criteria]:checked').val();

			if($('#maxPairsChk').is(':checked')) {
				params['maxPairs'] = $('#maxPairs').val();
			}

			if(betweenPairsRequest != null) {
				betweenPairsRequest.abort();
			}
			betweenPairsRequest = $.ajax({
				url: routeApi + 'distance/betweenPairs.json?apikey=' + apiKey,
				method: routeMethod,
				data: params,
				success: function(data) {
					//var fromPoint = data.fromPoints[data.pairs[0].from];
					//var toPoint = data.toPoints[data.pairs[0].to];
					$('#timing').html("BetweenPairs calculated in " + data.executionTime/1000 + " seconds.");
					$('#results').html("<pre>" + JSON.stringify(data, null, '\t') + "</pre>");
					if(betweenPairsLayer != null) {
						map.removeLayer(betweenPairsLayer);
					}
					betweenPairsLayer = L.layerGroup();
					for(var i = 0; i < data.pairs.length; i++) {
						var pair = data.pairs[i];
						if(pair.routeFound) {
							var fromPoint = data.fromPoints[pair.from];
							var toPoint = data.toPoints[pair.to];
							var line = L.polyline([[fromPoint[1],fromPoint[0]],[toPoint[1],toPoint[0]]], {color: 'red'});
							betweenPairsLayer.addLayer(line.bindTooltip(pair.distance + ' km in ' + pair.timeText));
						}
					}
					betweenPairsLayer.addTo(map);
				},
				error: function(request) {
					if(request.statusText != "abort") {
						$('#timing').html("Error retrieving betweenPairs results, please try your request again.");
						$('#results').html(request.responseText);
						console.log(request);
					}
				}
			});
		}

		$('#execute').on('click', betweenPairs);

		Sortable.create(document.getElementById('fromList'),{
			group: "addresses",
			handle: ".reorder",
			draggable: ".form-group",
			forceFallback: true
		});

		Sortable.create(document.getElementById('toList'),{
			group: "addresses",
			handle: ".reorder",
			draggable: ".form-group",
			forceFallback: true
		});

		// press enter on router field
		$('.addressList').on('keypress', 'input.input-field', function(e) {
			if(e.which == 13) {
				var latLng = isCoords($(this).val());
				if(latLng) {
    				receiveGeocode(latLng, $(this));
				}
    			return false;
  			}
		});

		// pick random location button
		$('.addressList').on('click', 'button.random', function() {
			randomAddress($(this).parents('div.form-group').find('input.input-field'), 'accessPoint', function(data, $field) {
				receiveGeocode(data, $field, false);
			}, $('#timing'));
		});

		// zoom to Location button
		$('.addressList').on('click', 'button.zoom-to', function() {
			var $inputField = $(this).parents('div.input-group').find('input.input-field');
			var marker = $inputField.data('marker');
			if(marker) {
				centerMap(marker.getBounds(), true);
			}
		});

		// clear router input field button
		$('.addressList').on('click', 'button.input-clear', function() {
			var $inputField = $(this).parents('div.input-group').find('input.input-field');
			var marker = $inputField.data('marker');
			if(marker) {
				map.removeLayer(marker);
			}
			// if there is more than 1 address
			if($(this).parents('.addressList').find('div.form-group').size() > 1) {
				// delete this destination field and route the remaining fields
				$(this).parents('div.form-group').remove();
			} else {
				// must leave at least 1 fields, just clear this field
				$inputField.val('');
				$inputField.data('marker', null);
			}
		});

		// add destination button
		$('.addAddrBtn').on('click', function() {
			var $list = $(this).parents('.listWrapper').find('.addressList');
			var numInput = parseInt($(this).parents('.controls').find('.input-field').val());
			if(numInput < 1 || numInput > 100) {
				numInput = 1;
			}
			for(var i = 0; i < numInput; i++) {
				var $formGroup = $('#fromList > .form-group:first-child').clone().appendTo($list);
				var $input = $formGroup.find('input.input-field');
				$input.val('');
				$input.data('marker', null);
				$input.autocomplete({
					minLength: 3,
					source: function(request, response) {
						geocodeSuggest(request, response, {
							locationDescriptor: 'accessPoint'
						});
					},
					select: function(evt, ui) {
						receiveGeocode(ui.item.data, $(evt.target));
					}
				});
				$formGroup[0].scrollIntoView(false);
				randomAddress($input, 'accessPoint', function(data, $field) {
					receiveGeocode(data, $field, false);
				});
			}
		});

		function receiveGeocode(data, $field, center = true) {
			var layer, latLng;
			var pos = $field.parents('div.form-group').index();
			var list = $field.parents('.addressList').attr('id');
			var icon
			if(list == 'fromList') {
				icon = greenIcon;
			} else {
				icon = redIcon;
			}
			if(data instanceof L.LatLng) {
				latLng = data;
				layer = latLngToLayer(data, {icon: icon});
			} else {
				// sort out whether we have a single feature or a featureCollection
				var feature = data;
				if(data.features) {
					feature = data.features[0];
				}
				$field.val(feature.properties.fullAddress);
				latLng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
				layer = L.geoJson(data, {
					pointToLayer: function (feature, latlng) {
						return L.marker(latlng, {icon: icon});
					},
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText({'fullAddress': feature.properties['fullAddress']}));
						layer.options['title'] = feature.properties.fullAddress;
					}
				});
			}
			var oldMarker = $field.data('marker');
			if(oldMarker) {
				map.removeLayer(oldMarker);
			}
			$field.data('marker', layer);
			layer.addTo(map);
		}

		// Routing - Address autocomplete
		$('.addressList input.input-field').autocomplete({
			minLength: 3,
			source: function(request, response) {
				geocodeSuggest(request, response, {
					locationDescriptor: 'accessPoint'
				});
			},
			select: function(evt, ui) {
				receiveGeocode(ui.item.data, $(evt.target));
			}
		});

		function isCoords(input) {
			var matches = input.match(/^\s*(-?\d{1,3}(?:\.\d*)?)\s*,\s*(-?[0-9]{1,3}(?:\.\d*)?)\s*$/);
			if(matches != null) {
				var lat = matches[1];
				var lng = matches[2];
				if(lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
					return new L.latLng(lat,lng);
				}
			}
			return false;
		}

		// Random Address event handler
		function randomAddress($field, locationDescriptor, callback, $statusDiv = null, retries = 0) {
			if($statusDiv) {
				$statusDiv.html('Jumping to random civic address...');
			}
			var bounds = map.getBounds();
			var height = bounds.getNorth() - bounds.getSouth()
			var lat = (Math.random() * height * 0.8) + bounds.getSouth() + (height * 0.1);
			var west = bounds.getWest();
			var width = bounds.getEast() - west;
			var lng = (Math.random() * width * 0.8) + west + (width * 0.1);
			$.ajax({
				url: gcApi + "sites/nearest.json",
				data: {
					locationDescriptor: locationDescriptor,
					excludeUnits: true,
					onlyCivic: true,
					brief: true,
					point: lng + "," + lat
				},
				success: function(data) {
					if($statusDiv) {
						$statusDiv.empty();
					}
					$field.val(data.properties.fullAddress);
					return callback(data, $field);
				},
				error: function(request) {
					if(retries < 5) {
						randomAddress($field, locationDescriptor, callback, $statusDiv, retries+1);
					} else {
						if($statusDiv) {
							$statusDiv.empty();
						}
						alert(baseErrorMsg + "Error retrieving nearest site to random point, please try your request again.");
						console.log(request);
					}
				}
			});
		}

		function latLngToLayer(latLng, markerOptions) {
			var marker = L.marker(latLng, markerOptions);
			marker.bindPopup('<span class="popup-title">' + latLng.lat + "," + latLng.lng + '</span>');
			var layer = L.featureGroup([marker]);
			return layer;
		}

		function centerMap(bounds, center = true) {
			var options = {
				maxZoom: 16
			};
			if(center) {
				map.fitBounds(bounds.pad(0.25), options);
			} else if(!map.getBounds().contains(bounds.pad(0.25))) {
				// if the bounds aren't within the current map bounds
				// zoom out to include the bounds
				map.fitBounds(bounds.extend(map.getBounds()).pad(0.25), options);
			}
		}

	</script>
</body>
</html>
