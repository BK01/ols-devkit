<!DOCTYPE html>
<html>

<head>
	<title>BC Open Location Services Demo</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.css" />
	<link href="https://aehlke.github.io/tag-it/css/jquery.tagit.css" rel="stylesheet" type="text/css">
	<style>
		/* make the map fullscreen */
		body {
            padding: 0;
            margin: 0;
			display: flex;
    		flex-flow: column wrap;
		}
        html, body {
            height: 100%;
            width: 100%;
        }
		#map {
			position: absolute;
			top: 0;
			left: 0;
			bottom: 255px;
			right:0;
        }

		/* remove the header bar from the jquery-ui tabs */
		#tabs {
    		padding: 0px;
    		background: none;
    		border-width: 0px;
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			height: 300px;
			z-index: 1000;
		}
		#tabs .ui-tabs-nav {
		    padding-left: 0px;
		    background: transparent;
		    border-width: 0px 0px 1px 0px;
		    -moz-border-radius: 0px;
		    -webkit-border-radius: 0px;
		    border-radius: 0px;
		}
		#tabs .ui-tabs-panel {
    		border-width: 0px 1px 1px 1px;
			background-color: #FFF;
			height: 100%;
		}

		.ui-autocomplete{
    		z-index:1001 !important;
		}*/
	</style>
	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
</head>

<body>
	<div id="map"></div>
	<div id="tabs">
		<ul>
			<li><a href="#tabs-1">Geocode</a></li>
			<li><a href="#tabs-2">Route</a></li>
			<li><a href="#tabs-3">Occupants By Tags</a></li>
			<li><a href="#tabs-4">Occupants By Name</a></li>
		</ul>
		<div id="tabs-1">
			Geocode Address: <input id="geocodeField" type="text" style="width:400px"/><br/>
			<button id="geocode" type="button">Geocode</button>
		</div>
		<div id="tabs-2">
			Route:<br/>
			Address From: <input id="fromGeocodeField" type="text" style="width:400px"/><br/>
			Address To: <input id="toGeocodeField" type="text" style="width:400px"/><br/>
			<div class="section">
				<input type="radio" name="criteria" value="fastest" checked="checked"/>fastest
				<input type="radio" name="criteria" value="shortest"/>shortest
			</div>
			<button id="addRoute" type="button">Add Route to Layers</button>
		</div>
		<div id="tabs-3">
			Find occupants nearby:<br/>
			Tags: <ul id="tags"></ul>
			<button id="findNearbyOccs" type="button">Find nearby</button>
		</div>
		<div id="tabs-4">
			Find Occupants by Name:<br/>
			Name: <input id="nameField" type="text" /><br/>
			<button id="findOccsByName" type="button">Find Occupants</button>
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
	<script src="https://aehlke.github.io/tag-it/js/tag-it.js"></script>
	<script>
		// Leaflet Map setup
		var map = L.map('map').setView([48.44, -123.37], 12);
		var baseLayers = {};
		var overlays = {};

		var bcRoadsBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcgis/services/province/roads_wm/MapServer/WmsServer?',
			{
				layers: '0'
			});
		baseLayers['BC Roads'] = bcRoadsBaseLayer;
		bcRoadsBaseLayer.addTo(map);

		var bcBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcserver/services/province/web_mercator_cache/MapServer/WMSServer?',
			{
				layers: '0'
			});
		baseLayers['BC Base'] = bcBaseLayer;

		var osmLayer = L.tileLayer('httpss://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		});
		baseLayers['OpenStreetMap'] = osmLayer;

		var layerControl = L.control.layers(baseLayers, overlays).addTo(map);

		// tabs UI setup
		$( "#tabs" ).tabs();

		// reusable function for suggesting geocode autocompletion options
		function geocodeSuggest(request, response) {
			$.ajax({
				url: "https://test.apps.gov.bc.ca/pub/geocoder/addresses.json",
				data: {
					minScore: 50,
					maxResults: 5,
					addressString: request.term
				},
				success: function(data) {
					var list = [];
					if(data.features && data.features.length > 0) {
						list = data.features.map( function(item) {
							return {
								value: item.properties.fullAddress,
								data: item
							}
						});
					}
					response(list);
				},
				error: function() {
					response([]);
				}
			});
		}

		// Geocode Address autocomplete
		$('#geocodeField').autocomplete({
			minLength: 3,
			source: geocodeSuggest
		});

		// Geocode Address event handler
		function geocode($field) {
			$.ajax({
				url: "https://test.apps.gov.bc.ca/pub/geocoder/addresses.json",
				data: {
					addressString: $field.val()
				},
				success: function(data) {
					var newLayer = L.geoJson(data, {
						onEachFeature: function(feature, layer) {
							layer.bindPopup(JSON.stringify(feature.properties));
						}
					}).addTo(map);
					map.fitBounds(newLayer.getBounds().pad(0.5));
					layerControl.addOverlay(newLayer, "Geocode results for \""
						+ $('#geocodeField').val() + "\"");
				},
				error: function(stuff) {
					alert("error loading geocode results.");
					console.log(stuff);
				}
			});
		}

		$('#geocodeField').keypress(function (e) {
 			if (e.which == 13) {
    			geocode($('#geocodeField'));
    			return false;
  			}
		});

		$('#geocode').on("click", function() {
			geocode($('#geocodeField'));
		});

		// Routing
		var fromAddress, toAddress;
		var fromLayer, toLayer, routeLayer;

		function route(fromAddress, toAddress) {
			if(!fromAddress || !toAddress) {
				return;
			}

			var routeUrl = "https://router.api.gov.bc.ca/route.json";
			$.ajax({
				url: routeUrl,
				data: {
					apikey: "a82472ff8f754968b4e70943adc63888",
					criteria: $('input[name=criteria]:checked').val(),
					points: fromAddress.geometry.coordinates[0] + ","
							+ fromAddress.geometry.coordinates[1] + ","
							+ toAddress.geometry.coordinates[0] + ","
							+ toAddress.geometry.coordinates[1]
				},
				success: function(data) {
					if(routeLayer) {
						map.removeLayer(routeLayer);
					}
					routeLayer = L.geoJson({
							type: "Feature",
							properties: {},
							geometry: {
								type: "LineString",
								coordinates: data.route
							}
						}, {
						onEachFeature: function(feature, layer) {
							layer.bindPopup(JSON.stringify(feature.properties));
						}
					}).addTo(map);
					map.fitBounds(routeLayer.getBounds().pad(0.5));
				},
				error: function(stuff) {
					alert("error loading route results.");
					console.log(stuff);
				}
			});
			// $('#directions').empty();
			// var directionsUrl = routeUrl.replace("route.kml", "directions.json");
			// $.getJSON(directionsUrl, function(data) {
			// 	$('#timing').empty();
			// 	$('#timing').append("Trip Duration: " + data.time);
			// 			var dirs = data.directions;
			// 	for(i = 0; i < dirs.length; i++) {
			// 		$('#directions').append("<div class=\"direction\">" + dirs[i] + "</div>");
			// 	}
			// });
		}

		// Routing - from Address autocomplete
		$('#fromGeocodeField').autocomplete({
			minLength: 3,
			source: geocodeSuggest,
			select: function(event,ui) {
				if(fromLayer) {
					map.removeLayer(fromLayer);
				}
				fromAddress = ui.item.data;
				fromLayer = L.geoJson(ui.item.data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(JSON.stringify(feature.properties));
					}
				}).addTo(map);
				route(fromAddress,toAddress);
			}
		});

		// Routing - to Address autocomplete
		$('#toGeocodeField').autocomplete({
			minLength: 3,
			source: geocodeSuggest,
			select: function(event,ui) {
				if(toLayer) {
					map.removeLayer(toLayer);
				}
				toAddress = ui.item.data;
				toLayer = L.geoJson(ui.item.data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(JSON.stringify(feature.properties));
					}
				}).addTo(map);
				route(fromAddress,toAddress);
			}
		});

		// handle changes to the criteria by re-routing
		$('input[name=criteria]').change( function() {
				route(fromAddress,toAddress);
		});

		// add the layer to the layer List more "permanently"
		$('#addRoute').click( function() {
			var newLayer = L.layerGroup([fromLayer, toLayer, routeLayer]);
			layerControl.addOverlay(newLayer, "Route from "
				+ fromAddress.properties.fullAddress + " to "
				+ toAddress.properties.fullAddress);
			fromLayer = null;
			toLayer = null;
			routeLayer = null;
			fromAddress = null;
			toAddress = null;
			$('#fromGeocodeField').val('');
			$('#toGeocodeField').val('');
		});

		// Tag-it setup (including autocomplete) for Occupants by tag
		$('#tags').tagit({
			allowSpaces: true,
			autocomplete: {
				source: function(request, response) {
					$.ajax({
						url: "https://delivery.apps.gov.bc.ca/pub/geocoder/occupants/tags.json",
						data: {tag: request.term},
						success: response,
						error: function() {
							response([]);
						}
					});
				}
			}
		});

		// Find nearby Occupants by Tag event handler
		$('#findNearbyOccs').on("click", function() {
			if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					function(position) {
						var tagList = $('#tags').tagit("assignedTags").join(";");
						$.ajax({
							url: "https://test.apps.gov.bc.ca/pub/geocoder/occupants/near.json",
							data: {
								tags: tagList,
								maxResults: 10,
								point: position.coords.longitude + "," +position.coords.latitude
							},
							success: function(data) {
								if(data.features && data.features.length > 0) {
									var newLayer = L.geoJson(data, {
										onEachFeature: function(feature, layer) {
											layer.bindPopup(JSON.stringify(feature.properties));
										}
									}).addTo(map);

									map.fitBounds(newLayer.getBounds().pad(0.5));
									layerControl.addOverlay(newLayer, "Occupants tagged with \""
										+ tagList + "\"");
								} else {
									alert("No occupants were found.");
								}
							},
							error: function(stuff) {
								alert("Error loading nearby occupants.");
								console.log(stuff);
							}
						});
					},
					function() {
						alert("There was a problem determining your location.");
					},
					{timeout:5000}
				);
			} else {
				alert("Your browser doesn't support geolocation.")
			}
		});

		// Find Occupants By Name Autocomplete
		$('#nameField').autocomplete({
			minLength: 4,
			source: function(request, response) {
				$.ajax({
					url: "https://test.apps.gov.bc.ca/pub/geocoder/occupants/addresses.json",
					data: {
						minScore: 50,
						maxResults: 5,
						addressString: request.term + "--"
					},
					success: function(data) {
						var list = [];
						if(data.features && data.features.length > 0) {
							list = data.features.map( function(item) {
								return item.properties.fullAddress;
							});
						}
						response(list);
					},
					error: function() {
						response([]);
					}
				});
			}
		});

		// Find Occupants By Name event handler
		$('#findOccsByName').on("click", function() {
			$.ajax({
				url: "https://test.apps.gov.bc.ca/pub/geocoder/occupants/addresses.json",
				data: {
					addressString: $('#nameField').val() + "--"
				},
				success: function(data) {
					var newLayer = L.geoJson(data, {
						onEachFeature: function(feature, layer) {
							layer.bindPopup(JSON.stringify(feature.properties));
						}
					}).addTo(map);
					layerControl.addOverlay(newLayer, "Occupants tagged with \""
						+ tagList + "\"");
				},
				error: function(stuff) {
					alert("Error loading occupants by name.");
					console.log(stuff);
				}
			});
		});
	</script>
</body>

</html>
